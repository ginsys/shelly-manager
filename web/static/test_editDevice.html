<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EditDevice Function Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #28a745; }
        .fail { background-color: #f8d7da; border-color: #dc3545; }
        .pending { background-color: #fff3cd; border-color: #ffc107; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; white-space: pre-wrap; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #mock-server-status { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 3px; }
        .modal { display: none; }
        #editDeviceModal { display: block; position: fixed; top: 50px; left: 50px; width: 400px; background: white; border: 1px solid #ccc; padding: 20px; }
    </style>
</head>
<body>
    <h1>EditDevice Function Test Suite</h1>
    <div id="mock-server-status">Mock server status: <span id="server-status">Not started</span></div>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
    
    <div id="test-results"></div>
    
    <!-- Mock modal elements for testing -->
    <div id="editDeviceModal" class="modal" style="display: none;">
        <h2 id="editDeviceModalTitle">Edit Device Configuration</h2>
        <div id="editDeviceLoading">Loading...</div>
        <div id="editDeviceError" style="display: none;">
            <p id="editDeviceErrorMessage">Error message</p>
        </div>
        <div id="editDeviceForm" style="display: none;">
            <p>Form content</p>
        </div>
        <div id="save-status"></div>
    </div>

    <script>
        // Constants and global variables
        const API_BASE = '/api/v1';
        let testResults = [];
        let mockServer = null;
        
        // Mock the console.log to capture logs for testing
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        let testLogs = [];
        
        function captureConsole() {
            testLogs = [];
            console.log = (...args) => {
                testLogs.push({ type: 'log', message: args.join(' ') });
                originalConsoleLog(...args);
            };
            console.error = (...args) => {
                testLogs.push({ type: 'error', message: args.join(' ') });
                originalConsoleError(...args);
            };
        }
        
        function restoreConsole() {
            console.log = originalConsoleLog;
            console.error = originalConsoleError;
        }
        
        // Mock functions needed by editDevice
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        async function getDeviceCapabilities(id) {
            return ['wifi', 'mqtt', 'auth'];
        }
        
        function updateTabsForCapabilities(capabilities) {
            // Mock implementation
        }
        
        function populateDeviceForm(config) {
            // Mock implementation
        }
        
        function clearDeviceForm() {
            // Mock implementation
        }
        
        // Mock fetch function for different test scenarios
        function createMockFetch(scenario) {
            return async (url, options) => {
                await new Promise(resolve => setTimeout(resolve, 10)); // Simulate network delay
                
                switch (scenario) {
                    case 'success':
                        if (url.includes('/config/typed')) {
                            return {
                                ok: true,
                                status: 200,
                                json: async () => ({
                                    configuration: {
                                        wifi: { enable: true, ssid: 'test-network' },
                                        mqtt: { enable: true, server: 'test-broker' },
                                        auth: { enable: true, user: 'admin' }
                                    },
                                    validation: {
                                        valid: true,
                                        errors: [],
                                        warnings: [
                                            { field: 'mqtt', message: 'Test warning', code: 'TEST_WARNING' }
                                        ]
                                    }
                                })
                            };
                        }
                        break;
                    case 'not-found':
                        return {
                            ok: false,
                            status: 404,
                            statusText: 'Not Found',
                            text: async () => 'Device not found'
                        };
                    case 'server-error':
                        return {
                            ok: false,
                            status: 500,
                            statusText: 'Internal Server Error',
                            text: async () => 'Internal server error'
                        };
                    case 'invalid-json':
                        return {
                            ok: true,
                            status: 200,
                            json: async () => ({ invalid: 'response' })
                        };
                    case 'network-error':
                        throw new Error('Network error');
                }
                
                return {
                    ok: false,
                    status: 500,
                    statusText: 'Mock error'
                };
            };
        }
        
        // Include the editDevice function from the main HTML file
        ${getEditDeviceFunction()}
        
        // Test cases
        const tests = [
            {
                name: 'editDevice - Successful configuration load',
                test: async () => {
                    window.fetch = createMockFetch('success');
                    captureConsole();
                    
                    await editDevice(1);
                    
                    restoreConsole();
                    
                    // Check modal state
                    const modal = document.getElementById('editDeviceModal');
                    const loading = document.getElementById('editDeviceLoading');
                    const form = document.getElementById('editDeviceForm');
                    const error = document.getElementById('editDeviceError');
                    const title = document.getElementById('editDeviceModalTitle');
                    const status = document.getElementById('save-status');
                    
                    const assertions = [
                        { condition: modal.style.display === 'block', message: 'Modal should be visible' },
                        { condition: loading.style.display === 'none', message: 'Loading should be hidden' },
                        { condition: form.style.display === 'block', message: 'Form should be visible' },
                        { condition: error.style.display === 'none', message: 'Error should be hidden' },
                        { condition: title.textContent === 'Edit Device Configuration - ID: 1', message: 'Title should be updated' },
                        { condition: status.textContent.includes('Configuration loaded successfully'), message: 'Status should show success' },
                        { condition: status.textContent.includes('(1 warnings)'), message: 'Should show warning count' },
                        { condition: window.currentEditDeviceId === 1, message: 'Should store device ID' }
                    ];
                    
                    const logs = testLogs.filter(log => log.message.includes('Fetching configuration')).length > 0;
                    assertions.push({ condition: logs, message: 'Should log fetch operation' });
                    
                    return assertions;
                }
            },
            
            {
                name: 'editDevice - Device not found (404)',
                test: async () => {
                    window.fetch = createMockFetch('not-found');
                    captureConsole();
                    
                    await editDevice(999);
                    
                    restoreConsole();
                    
                    const loading = document.getElementById('editDeviceLoading');
                    const form = document.getElementById('editDeviceForm');
                    const error = document.getElementById('editDeviceError');
                    const errorMessage = document.getElementById('editDeviceErrorMessage');
                    const status = document.getElementById('save-status');
                    
                    return [
                        { condition: loading.style.display === 'none', message: 'Loading should be hidden' },
                        { condition: form.style.display === 'none', message: 'Form should be hidden' },
                        { condition: error.style.display === 'block', message: 'Error should be visible' },
                        { condition: errorMessage.textContent.includes('404'), message: 'Should show 404 error' },
                        { condition: errorMessage.textContent.includes('Device not found'), message: 'Should show error details' },
                        { condition: status.textContent === 'Failed to load configuration', message: 'Status should show failure' },
                        { condition: status.className === 'error', message: 'Status should have error class' }
                    ];
                }
            },
            
            {
                name: 'editDevice - Server error (500)',
                test: async () => {
                    window.fetch = createMockFetch('server-error');
                    captureConsole();
                    
                    await editDevice(1);
                    
                    restoreConsole();
                    
                    const errorMessage = document.getElementById('editDeviceErrorMessage');
                    
                    return [
                        { condition: errorMessage.textContent.includes('500'), message: 'Should show 500 error' },
                        { condition: errorMessage.textContent.includes('Internal server error'), message: 'Should show server error details' }
                    ];
                }
            },
            
            {
                name: 'editDevice - Invalid response structure',
                test: async () => {
                    window.fetch = createMockFetch('invalid-json');
                    captureConsole();
                    
                    await editDevice(1);
                    
                    restoreConsole();
                    
                    const errorMessage = document.getElementById('editDeviceErrorMessage');
                    
                    return [
                        { condition: errorMessage.textContent.includes('Invalid configuration data structure'), message: 'Should show structure validation error' }
                    ];
                }
            },
            
            {
                name: 'editDevice - Network error',
                test: async () => {
                    window.fetch = createMockFetch('network-error');
                    captureConsole();
                    
                    await editDevice(1);
                    
                    restoreConsole();
                    
                    const errorMessage = document.getElementById('editDeviceErrorMessage');
                    
                    return [
                        { condition: errorMessage.textContent.includes('Network error'), message: 'Should show network error' }
                    ];
                }
            }
        ];
        
        // Test runner functions
        async function runTest(test) {
            try {
                const assertions = await test.test();
                const passed = assertions.filter(a => a.condition).length;
                const total = assertions.length;
                
                return {
                    name: test.name,
                    passed: passed === total,
                    assertions: assertions,
                    passedCount: passed,
                    totalCount: total,
                    error: null
                };
            } catch (error) {
                return {
                    name: test.name,
                    passed: false,
                    assertions: [],
                    passedCount: 0,
                    totalCount: 1,
                    error: error.message
                };
            }
        }
        
        async function runAllTests() {
            document.getElementById('server-status').textContent = 'Running tests...';
            testResults = [];
            
            for (const test of tests) {
                const result = await runTest(test);
                testResults.push(result);
            }
            
            displayResults();
            document.getElementById('server-status').textContent = 'Tests completed';
        }
        
        function displayResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            testResults.forEach(result => {
                const testDiv = document.createElement('div');
                testDiv.className = `test ${result.passed ? 'pass' : 'fail'}`;
                
                let assertionsHtml = '';
                if (result.assertions.length > 0) {
                    assertionsHtml = result.assertions.map(assertion => 
                        `<li style="color: ${assertion.condition ? 'green' : 'red'};">${assertion.message}</li>`
                    ).join('');
                }
                
                testDiv.innerHTML = `
                    <h3>${result.name} ${result.passed ? '✅' : '❌'}</h3>
                    <p>Passed: ${result.passedCount}/${result.totalCount}</p>
                    ${result.error ? `<p style="color: red;">Error: ${result.error}</p>` : ''}
                    ${assertionsHtml ? `<ul>${assertionsHtml}</ul>` : ''}
                `;
                
                resultsDiv.appendChild(testDiv);
            });
            
            // Summary
            const passed = testResults.filter(r => r.passed).length;
            const total = testResults.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `test ${passed === total ? 'pass' : 'fail'}`;
            summaryDiv.innerHTML = `<h2>Test Summary: ${passed}/${total} tests passed</h2>`;
            resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            testResults = [];
        }
        
        // Extract the editDevice function from the main HTML file
        function getEditDeviceFunction() {
            return \`
        async function editDevice(id) {
            console.log(\`Opening edit modal for device ID: \${id}\`);
            showModal('editDeviceModal');
            
            // Update modal title
            document.getElementById('editDeviceModalTitle').textContent = \`Edit Device Configuration - ID: \${id}\`;
            
            // Show loading state
            document.getElementById('editDeviceLoading').style.display = 'block';
            document.getElementById('editDeviceError').style.display = 'none';
            document.getElementById('editDeviceForm').style.display = 'none';
            
            // Store device ID for later use
            window.currentEditDeviceId = id;
            
            // Clear any previous form data
            clearDeviceForm();
            
            try {
                console.log(\`Fetching configuration for device \${id}...\`);
                
                // Fetch device capabilities and configuration in parallel
                const [capabilities, configResponse] = await Promise.all([
                    getDeviceCapabilities(id),
                    fetch(\`\${API_BASE}/devices/\${id}/config/typed\`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                console.log(\`Configuration response status: \${configResponse.status}\`);
                
                if (!configResponse.ok) {
                    let errorMessage;
                    try {
                        const errorData = await configResponse.text();
                        errorMessage = \`Failed to load configuration (\${configResponse.status}): \${errorData}\`;
                    } catch {
                        errorMessage = \`Failed to load configuration: \${configResponse.status} \${configResponse.statusText}\`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await configResponse.json();
                console.log('Configuration data loaded:', data);
                
                // Validate the response structure
                if (!data.configuration) {
                    throw new Error('Invalid configuration data structure - missing configuration object');
                }
                
                // Update tabs based on device capabilities
                updateTabsForCapabilities(capabilities);
                
                // Populate form with configuration data
                populateDeviceForm(data.configuration);
                
                // Show form and hide loading
                document.getElementById('editDeviceLoading').style.display = 'none';
                document.getElementById('editDeviceForm').style.display = 'block';
                
                // Set save status with validation info
                const validationStatus = data.validation && data.validation.valid ? '✓ Valid' : '⚠ Has validation issues';
                const warningCount = data.validation && data.validation.warnings ? data.validation.warnings.length : 0;
                document.getElementById('save-status').textContent = \`Configuration loaded successfully. \${validationStatus}\${warningCount > 0 ? \` (\${warningCount} warnings)\` : ''}\`;
                document.getElementById('save-status').className = 'success';
                
                console.log(\`Successfully loaded configuration for device \${id}\`);
                
            } catch (error) {
                console.error('Error loading device configuration:', error);
                
                // Show error state
                document.getElementById('editDeviceLoading').style.display = 'none';
                document.getElementById('editDeviceError').style.display = 'block';
                document.getElementById('editDeviceErrorMessage').textContent = error.message;
                
                // Set save status
                document.getElementById('save-status').textContent = 'Failed to load configuration';
                document.getElementById('save-status').className = 'error';
            }
        }\`;
        }
    </script>
</body>
</html>