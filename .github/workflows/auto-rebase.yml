name: Auto Rebase PRs

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: read

concurrency:
  group: auto-rebase
  cancel-in-progress: true

jobs:
  rebase:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Rebase open PR branches onto main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          gh pr list --base main --state open \
            --json number,headRefName,author \
            --jq '.[] | select(.author.login != "app/dependabot") | "\(.number) \(.headRefName)"' |
          while read -r pr branch; do
            [ -z "$pr" ] && continue
            echo "::group::PR #${pr} (${branch})"
            git fetch origin "$branch"
            git checkout -B "$branch" "origin/$branch"
            if git rebase origin/main; then
              git push --force-with-lease origin "$branch"
              echo "Rebased successfully"
            else
              echo "::warning::Rebase conflict on PR #${pr} ($branch)"
              git rebase --abort
            fi
            echo "::endgroup::"
          done
